Class new title: BitRectEditor	subclassof: Window	fields: 'tool saveToolPic saveActionPic picture dirty formUnderEdit fontUnderEdit characterIndex'	declare: 'characterIndex tools windowmenu actionpic actionbuttons FontUnderEdit toolpic formUnderEdit ';	classified: 'Windows'BitRect understands: 'copyToForm: destForm at: loc | strips strip offset i	[offset _ loc - self origin.	strips_self strips.	for i to: strips length do		[strip _ stripsi.		(strip origin + offset rect: strip corner + offset)			bitsFromString: datai into: destForm]]' classified: 'As yet unclassified'BitRect understands: 'edit | ed  "BitRect new fromuser edit. "	[user leaveTop.	ed_BitRectEditor new picture: self.	ed frame: (Rectangle fromuser origin extent: self extent); show.	user schedule: ed]' classified: 'As yet unclassified'BitRectEditor understands: 'classComment [''BitRectEditor edits BitRects, Forms, Cursors, and Fonts.To create, say:	BitRect new fromuser edit.	Form fromuser edit.	NormalCursor asForm edit.	(DefaultTextStyle font: 0) edit: ''''A''''.  - (single qutoes here)This installs a BitRectEditor in the scheduler and starts it up.The editing tools are to the left of the picture.  (The first one looks like a doodle).  They are: draw-thin, erase, straightedge, gray-block, paintbrush, magnifier.  The actions for the tools are displayed above the picture.See BitRectTool for explanations of the actions.CAUTION: this ordering is arbitrary.  It is currently possible to set a new action for any of the tools, so that if you are not careful, the straightedge will start being a magnifier or whatever.  This should get fixed eventually.tools = a RadioButtons. Each button owns a BitRectTool (the active one is held in tool).actionbuttons = a Vector of RadioButtons.  The groups of buttons are: action, mode, pen width, gray, and grid.toolpic = BitRect of icons for the tools (at side of picture).actionpic = BitRect of icons for the parts of a tool (above picture)windowmenu = menu for bluebug.To edit a copy of the tool picture, say	newpic_(BitRectEditortoolpic) recopy.	newpic edit.To install this copy as the menu picture, say	BitRectEditor new toolpic: newpic recopy.Do the analogous thing to edit the action picture.Caution: the editor blows up if you edit the tool picture itself and not a copy.'']' classified: 'As yet unclassified'BitRectEditor understands: 'enter | start pt b	["Periodically check if the mouse is still in the frame.		If not, stop showing the picture"	self show.  picture show.	"self lostMouse[false]."	dirty_false.	for b from: actionbuttons do [b reset].	"show action menu above the picture"	start_frame origin-1.	pt _ start-(0actionpic extent y).	actionpic moveto: pt.	saveActionPic_actionpic bitsIntoString.	self lostMouse[false]	"last point I can return before having to restore bits under menus"	actionpic show.	pt _ actionbuttons1 moveto: pt. "action"	pt _ actionbuttons3 moveto: pt. "mode"	pt _ actionbuttons4 moveto: pt. "width"	"show the next bank of action buttons"	pt _ start-(0(actionpic extent y+1/2)).	pt _ actionbuttons2 moveto: pt.  "tone"	pt _ actionbuttons5 moveto: pt.  "grid"	tool brushpt: (pt _ pt+(44)).	(tool brush) moveto: pt; show.	"show the tool pic"	pt _ start-(toolpic extent x0).	toolpic moveto: pt.	saveToolPic _ toolpic bitsIntoString.	toolpic show.	tools moveto: pt;  setvalue: tool.	tool frame: frame; showon: actionbuttons.]' classified: 'As yet unclassified'BitRectEditor understands: 'fontUnderEdit: font characterIndex: charix	[fontUnderEdit _ font.	characterIndex _ charix.	formUnderEdit _ fontUnderEdit charForm: charix]' classified: 'As yet unclassified'BitRectEditor understands: 'formUnderEdit  | f  "outside access to the bitRect being edited as a form"	"Note - if not editing forms and cursors the result will be a copy"	[formUnderEditnilfalse[ formUnderEdit].	f _ Form new extent: picture extent.	picture copyToForm: formUnderEdit at: 00.	 f]' classified: 'As yet unclassified'BitRectEditor understands: 'formUnderEdit: form	[formUnderEdit _ form]' classified: 'As yet unclassified'BitRectEditor understands: 'leave	[[nilsaveActionPic[]		actionpic bitsFromString: saveActionPic.		saveActionPic _ nil.].		[nil saveToolPic[]		toolpic bitsFromString: saveToolPic.		saveToolPic_nil].	[dirty[picture saveScreenBits. dirty _ false]].	[fontUnderEditnilfalse		[picture copyToForm: formUnderEdit at: 00.		fontUnderEdit charForm: characterIndex _ formUnderEdit].	 formUnderEditnilfalse		[picture copyToForm: formUnderEdit at: 00]].	"frame border: 2 color: white"]' classified: 'As yet unclassified'BitRectEditor understands: 'show	[super show.	picture show]' classified: 'As yet unclassified'BitRectTool understands: 'draw	[pencil color: tone; inking: mode; width: [penwidth  nil[2] penwidth].	pencil place: self mpOnGrid.	while user redbug do			[pencil goto: self mpOnGrid]]' classified: 'As yet unclassified'Cursor understands: 'asForm   "NormalCursor asForm edit."	[Form new extent: self extent bits: bitstr offset: offset]' classified: 'As yet unclassified'Font understands: 'charForm: charix _ charForm  | ascii leftX rightX	[ascii _ charix.	[(ascii between: minascii and: maxascii)  false[ascii _ maxascii + 1]].	leftX _ xtable(ascii+1).	charForm displayat: leftX0 in: self glyphsForm]' classified: 'As yet unclassified'Font understands: 'edit: char  | charix charForm ed  "DefaultTextStyle fontset0 edit: ''A''. "	[charix _ [char is: String[char1] char].	user leaveTop.	charForm _ self charForm: charix.	ed_BitRectEditor new picture: (BitRect new readFromForm: charForm).	ed fontUnderEdit: self characterIndex: charix.	ed frame: (Rectangle fromuser origin extent: charForm extent); show.	user schedule: ed]' classified: 'As yet unclassified'Font understands: 'glyphsForm   "Note: must share the glyphs bits for edit to work."	[ Form new extent: xtablextable lengthself height bits: glyphs]' classified: 'As yet unclassified'Form understands: 'displayat: pt effect: mode in: destForm | bnds 	[bnds _ Rectangle new origin: pt extent: self extent.	bnds bitsFromString: bits into: destForm mode: mode clippedBy: nil]' classified: 'As yet unclassified'Form understands: 'displayat: pt in: destForm  	[self displayat: pt effect: storing in: destForm]' classified: 'As yet unclassified'Form understands: 'edit  | ed   "Form fromuser edit."	[user leaveTop.	ed_BitRectEditor new picture: (BitRect new readFromForm: self).	ed formUnderEdit: self.	ed frame: (Rectangle fromuser origin extent: self extent); show.	user schedule: ed]' classified: 'As yet unclassified'Rectangle understands: 'bitsFromString: str into: destForm	[self bitsFromString: str into: destForm mode: storing clippedBy: nil]' classified: 'As yet unclassified'Rectangle understands: 'bitsFromString: str into: destForm mode: mode clippedBy: rect  | blt clipRect	[clipRect _ [rectnil[00 rect: destForm extent] rect].	blt _ BitBlt new.	blt destForm_ destForm;  window: clipRect.	blt function_ mode.	blt sourceForm_ Form new extent: corner - origin bits: str offset: nil.	blt dest_ origin.	blt extent_ corner - origin.	blt source_ 0  0.	blt callBLT]' classified: 'As yet unclassified'Rectangle understands: 'bitsFromString: str mode: mode	[self bitsFromString: str into: DisplayForm mode: mode clippedBy: nil]' classified: 'As yet unclassified'Rectangle understands: 'bitsFromString: str mode: mode clippedBy: rect	[self bitsFromString: str into: DisplayForm mode: mode clippedBy: rect]' classified: 'As yet unclassified'Rectangle understands: 'bitsIntoString: str mode: mode clippedBy: clipRect	[self bitsIntoString: str from: DisplayForm mode: mode clippedBy: clipRect]' classified: 'As yet unclassified'